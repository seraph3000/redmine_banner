# Redmine Banner プラグイン（Seraph3000版）

これは Akiko Takano さんの Redmine Banner プラグインを、
Redmine 4 / 5 / 6 向けに拡張・保守している fork です。

- 元リポジトリ: https://github.com/akiko-pusu/redmine_banner
- 本 fork: https://github.com/seraph3000/redmine_banner
- 対応 Redmine: 4.x / 5.x / 6.x

## この fork で追加している主な機能

- Redmine **4 / 5 / 6** 対応
- **プロジェクトごとのロール別バナー**
  （ロールごとに異なるメッセージを設定可能）
- **強制表示オプション**
  （一定条件でバナーを必ず表示）
- **ロール名ラベルの色付け**
  （ロールごとに色分けされたラベルを表示）
- **バナーマクロ機能**
  - カウントダウン（締切・メンテナンスなど）
  - 日付・時刻
  - 環境情報（PROD / STG / DEV など）
  - ユーザー情報（最終ログイン、ログイン順位 など）
- ローカライズ修正・細かな UI 改善

`README.md` は英語版、この `README_ja.md` は日本語向けドキュメントです。

---

## インストール

1. このプラグインを Redmine の `plugins` ディレクトリ直下に配置します。

   例:
   `REDMINE_ROOT/plugins/redmine_banner`

2. プラグインのマイグレーションを実行します。

   ```bash
   bundle exec rake redmine:plugins:migrate NAME=redmine_banner RAILS_ENV=production
   ```

3. Redmine を再起動します。

   Passenger / Puma / Thin / Unicorn など、運用しているアプリサーバの再起動方法に従ってください。

アンインストールする場合は、以下を実行します。

   ```bash
    bundle exec rake redmine:plugins:migrate NAME=redmine_banner VERSION=0 RAILS_ENV=production
   ```

---

## サイト全体バナー（グローバルバナー）の使い方

1. 管理者としてログインします。
2. 「管理」→「プラグイン」→「Redmine Banner」の「設定」を開きます。
3. 「バナーを有効にする」を ON にし、メッセージ・種別・表示位置などを設定します。
4. 「適用」を押すと、サイト全体にバナーが表示されます。

グローバルバナーには、後述の **バナーマクロ** を利用できます。

---

## バナーマクロ（この fork で追加された機能）

この fork では、グローバルバナー／プロジェクトバナー共通で、
メッセージ中の特定のパターンを **マクロ** として展開できます。

* マクロはすべて `%{...}` 形式で記述します。
* 多くは「現在時刻」や「ログイン中のユーザー情報」を元に自動計算されます。
* 未ログイン時（匿名ユーザー）の場合、一部マクロは空文字を返します。

### カウントダウンマクロ

指定した日時までの残り時間を表示するマクロです。 \
日時は Redmine／ユーザーのタイムゾーン設定に従って解釈されます。

利用できるマクロは次のとおりです。

* `%{cdate:YYYY-MM-DD HH:MM}` \
  指定日時までの「残り日数」（整数）

* `%{chours:YYYY-MM-DD HH:MM}` \
  指定日時までのうち、「日」を除いた「残り時間（0〜23）」

* `%{cmin:YYYY-MM-DD HH:MM}` \
  指定日時までのうち、「日」と「時間」を除いた「残り分（0〜59）」

* `%{ctime:YYYY-MM-DD HH:MM}` \
  指定日時までの「総時間」を `HH:MM` 形式で表示 \
  例: `120:15`（= 120時間15分）

#### 使用例

```text
メンテナンス開始まで
残り %{cdate:2026-02-02 08:00} 日
%{chours:2026-02-02 08:00} 時間
%{cmin:2026-02-02 08:00} 分です。
```

指定日時を過ぎた場合は、以下のように振る舞います。

* `cdate` / `chours` / `cmin` … `0` を返す
* `ctime` … `00:00` を返す

---

### 日付・時刻・環境マクロ

#### 日付・時刻

* `%{today}`
  現在の日付を、ユーザーの言語設定・日付形式に従って表示します。
  （内部的に `format_date` を使用）

* `%{now}`
  現在の日付と時刻を、ユーザーの言語設定・時刻形式に従って表示します。
  （内部的に `format_time` を使用）

使用例:

```text
%{today} 時点のご案内です。
このバナーは %{now} に更新されました。
```

#### 環境（Rails.env）表示

* `%{env}`
  Redmine が動作している Rails 環境に応じたラベルを返します。
  例: `PROD`, `STG`, `DEV` など。（実際のマッピングは fork 実装に依存）

使用例:

```text
[%{env}] 環境からのお知らせです。
```

複数インスタンス（本番／検証／開発など）を運用している場合に、
「どの環境のバナーか」を一目で判断する用途を想定しています。

---

### ユーザー関連マクロ

これらのマクロは、**ログインしているユーザーに対してのみ**値を返します。
匿名ユーザー（未ログイン）の場合は空文字列になります。

#### ログインユーザー名

* `%{user_name}`
  現在ログインしているユーザーの表示名を返します。
  （`User.current.name` 相当）

使用例:

```text
%{user_name} さんへのお知らせです。
```

#### 最終ログイン日時

* `%{user_last_login}`
  `User.current.last_login_on` を元に、ユーザーの言語・時刻形式に従って表示します。\
  ただし **ログインページ（/login）では表示されません**（空文字を返します）。

使用例:

```text
あなたの最終ログイン日時：%{user_last_login}
```

#### 今日何人目のログインか

* `%{user_login_rank_today}`
  「本日ログインしたユーザーのうち、何人目のログインか」を数えて返します。\
   ただし **ログインページ（/login）では表示されません**（空文字を返します）。\
  例: `5` → 「今日は 5 人目のログインです。」

使用例:

```text
今日は %{user_login_rank_today} 人目のログインです。
```

> **注意:**
> このマクロは、`users.last_login_on` を元に「同じ日付かつ自分までのログイン」を
> カウントする実装になるため、ユーザー数が非常に多い大規模インスタンスでは
> 若干 DB 負荷が増える可能性があります。負荷が気になる環境では利用を控えてください。

---

## プロジェクト単位バナーの使い方

バナーはプロジェクトモジュールとしても利用できます。

1. 対象プロジェクトの「設定」→「モジュール」で「Banner」にチェックを入れます。
2. プロジェクト設定に「Banner」タブが追加されます。
3. 「Banner」タブ内で、プロジェクト専用のバナーを設定できます。

プロジェクトバナーでも、グローバルバナーと同じ **バナーマクロ** が利用できます。

---

## ロール別プロジェクトバナー（fork の拡張機能）

この fork では、プロジェクトごとに「ロール別」のバナーを定義できます。

* バナーレコードは `project_id` と `role_id` を持ちます。

  * `role_id` が `NULL` のものは「デフォルト（全ロール共通）」として扱われます。
* あるプロジェクト画面でバナーを表示する際、以下のように選択されます。

1. 現在のユーザーがそのプロジェクトで持っているロール一覧を取得
2. そのロールに紐づくバナーが存在する場合

   * Redmine ロールの `position`（並び順）を元に、優先度の高いロールのバナーを 1つ表示
3. 一致するロール別バナーが見つからない場合

   * `role_id = NULL` の「共通バナー」を表示
4. それも存在しない場合

   * そのプロジェクトではバナーを表示しない

### 利用例

* プロジェクト管理者ロール向けバナー:

  > 「スプリント開始前に、担当未設定チケットを整理してください。」

* Reporter ロール向けバナー:

  > 「チケット作成時は『再現手順』欄の記入をお願いします。」

ロール別バナーを何も設定しない場合は、**元のプラグインと同様に「プロジェクトごとに 1つのバナー」** として動作します。

---

## 現在の制限事項

1. プロジェクトバナーは、タイマー（開始日時／終了日時）設定に対応していません。
2. プロジェクトバナーの表示位置は「プロジェクト画面の上部」のみです。
   フッター位置への表示は対応していません。
3. Redmine 3.x を利用する場合は、この fork ではなく、
   元のプラグインの古いバージョン（0.1.x 系）を利用してください。

---

## 変更履歴（この fork）

### 0.4.1

* グローバルバナー／プロジェクトバナー共通の **バナーマクロ機能** を追加

  * カウントダウンマクロ: `cdate`, `chours`, `cmin`, `ctime`
  * 日付・時刻: `today`, `now`
  * 環境: `env`
  * ユーザー情報: `user_name`, `user_last_login`, `user_login_rank_today`
* マクロ展開をグローバルバナー／プロジェクトバナー双方に適用

### 0.4.0

* `banners` テーブルに `role_id` カラムを追加
* ユーザーのロールに応じてプロジェクトバナーを選択するロジックを追加
* プロジェクトバナーにロール別バナー機能を実装
* 既存環境との互換性確保（`role_id` を利用しない場合は従来どおり）

それ以前の変更については、元プラグインの変更履歴を参照してください。

* [https://github.com/akiko-pusu/redmine_banner](https://github.com/akiko-pusu/redmine_banner)

---

## リポジトリ

* 元リポジトリ（オリジナル）
  [https://github.com/akiko-pusu/redmine_banner](https://github.com/akiko-pusu/redmine_banner)

* この fork
  [https://github.com/seraph3000/redmine_banner](https://github.com/seraph3000/redmine_banner)

---

## ライセンス

本プラグインは、オリジナル版と同じく **GNU GPL v2** のもとで配布されます。

* 詳細は同梱の `COPYRIGHT` および `COPYING` を参照してください。
* 著作権は元作者である Akiko Takano さんに帰属します。
* 本 fork で追加された改変部分も、同じライセンスに従います。

